<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Penal - ImersiON Roleplay</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- Vari√°veis de Cores --- */
        :root {
            --bg-deep-dark: #121212;        
            --bg-main-light: #181818; 
            --bg-dark-card: #202020; 
            --text-blue: #00aaff;
            --text-light-grey: #e0e0e0;    
            --text-dark-grey: #aaaaaa;      
            --border-color-dark: #333333; 
            --hover-bg: #2a2a2a;            
            --alert-red: #dc3545; 
            --input-bg: #2b2b2b; 
            --input-border: #444444; 
            --calc-result-bg: #1e1e1e; 
            --crime-header-bg: #2c2c2c; 
            --crime-header-text: #e0e0e0; 
            --original-red: #ca193a;
            --main-font: 'Montserrat', sans-serif;
            --shadow-light: rgba(0, 0, 0, 0.3);
        }

        /* --- TEMAS --- */
        [data-theme="light"] {
            --bg-deep-dark: #e0e0e0; --bg-main-light: #f4f4f4; --bg-dark-card: #ffffff;
            --text-light-grey: #333333; --text-dark-grey: #555555; --border-color-dark: #cccccc;
            --hover-bg: #e6e6e6; --input-bg: #ffffff; --input-border: #bbbbbb;
            --calc-result-bg: #ffffff; --crime-header-bg: #eeeeee; --crime-header-text: #333333;
            --shadow-light: rgba(0, 0, 0, 0.1);
        }
        [data-theme="police"] {
            --bg-deep-dark: #000000; --bg-main-light: #050505; --bg-dark-card: #0a0a0a;
            --text-blue: #0047AB; --text-light-grey: #cccccc; --border-color-dark: #333333;
            --input-bg: #111111; --calc-result-bg: #080808; --crime-header-bg: #1a1a1a; --hover-bg: #1f1f1f;
        }
        [data-theme="gold"] {
            --bg-deep-dark: #0f0f0f; --bg-main-light: #141414; --bg-dark-card: #1c1c1c;
            --text-blue: #d4af37; --border-color-dark: #443c20; --crime-header-bg: #292412; --crime-header-text: #d4af37;
        }

        /* Estilos Globais */
        body {
            font-family: var(--main-font); background-color: var(--bg-main-light); color: var(--text-light-grey);
            margin: 0; padding: 0; display: flex; flex-direction: column; 
            min-height: 100vh; overflow-x: hidden; font-weight: 400; transition: background-color 0.3s, color 0.3s;
        }
        .main-wrapper { display: flex; width: 100%; flex: 1; }
        .content-area {
            flex-grow: 1; padding: 0 40px 40px 40px; background-color: var(--bg-main-light);
            display: flex; flex-direction: column; overflow-y: auto; transition: background-color 0.3s;
        }
        
        /* --- CABE√áALHO --- */
        .quadrotopo {
            display: flex; align-items: center; justify-content: space-between; 
            padding: 20px 30px; margin-bottom: 30px; 
            background-color: var(--bg-dark-card); border-bottom: 3px solid var(--text-blue); 
            border-radius: 0 0 10px 10px; box-shadow: 0 4px 15px var(--shadow-light);
            gap: 20px; flex-wrap: wrap;
            transition: all 0.3s ease;
        }

        .corp-header {
            text-align: left; padding-right: 20px; border-right: 1px solid var(--border-color-dark);
            display: flex; flex-direction: column; justify-content: center;
        }
        .corp-header h2 { 
            font-size: 1.6em; font-weight: 700; color: var(--text-blue); 
            margin-top: 0; margin-bottom: 8px; white-space: nowrap; 
        }
        
        /* Container do Badge (Nome e Profiss√£o) */
        #user-badge-container {
            font-size: 1.1em; font-weight: 600; 
            display: flex; gap: 5px; align-items: center;
        }
        .badge-name { color: var(--text-blue); }
        .badge-job { color: var(--text-blue); filter: brightness(0.7); }

        .inputs-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: flex-end; }
        .input-group-item h3 { color: var(--text-light-grey); font-size: 0.9em; margin-bottom: 5px; font-weight: 600; }
        .input-group-item input {
            width: 200px; padding: 10px 12px; background-color: var(--input-bg); border: 1px solid var(--input-border);
            border-radius: 6px; color: var(--text-light-grey); font-size: 1em;
        }

        /* Container de Valores */
        .value-display-container {
            display: flex; flex-direction: column; justify-content: center;
            text-align: right;
            padding: 0 15px;
            border-right: 1px solid var(--border-color-dark);
        }
        .value-row { margin-bottom: 5px; white-space: nowrap; }
        .value-row label { font-size: 0.85em; color: var(--text-dark-grey); font-weight: 500; display: inline-block; margin-right: 5px;}
        .value-row span { font-size: 1em; font-weight: 700; color: var(--text-blue); }

        /* Agrupador da direita */
        .right-controls-wrapper {
            display: flex; align-items: center; gap: 15px; margin-left: auto; 
        }
        .social-buttons-container { display: flex; gap: 10px; }
        
        .icon-btn {
            color: var(--text-light-grey); background-color: var(--input-bg); padding: 0; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; border-radius: 6px; text-decoration: none; transition: 0.2s;
            border: 1px solid var(--input-border); cursor: pointer;
        }
        .icon-btn:hover, .icon-btn.active { background-color: var(--hover-bg); color: var(--text-blue); border-color: var(--text-blue); }
        .icon-btn i { font-size: 1.2em; }

        .btn-penal {
            background-color: var(--text-blue); color: #fff; border: none; padding: 10px 15px; border-radius: 6px;
            font-family: var(--main-font); font-weight: 700; font-size: 0.9em; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: nowrap;
        }
        .btn-penal:hover { filter: brightness(1.1); transform: translateY(-2px); }

        /* --- MODAL DE BOAS VINDAS (TUTORIAL) --- */
        .welcome-overlay {
            display: none; /* Ativado via JS */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 99999; /* Fica acima de tudo */
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        .welcome-modal {
            background-color: var(--bg-dark-card);
            border: 2px solid var(--text-blue);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            position: relative;
        }
        .welcome-modal h2 {
            color: var(--text-blue);
            margin-top: 0;
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        .welcome-modal p {
            color: var(--text-light-grey);
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        .welcome-btn {
            background-color: var(--text-blue);
            color: #fff;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
        }
        .welcome-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        /* --- SETTINGS --- */
        .settings-panel {
            display: none; position: absolute; top: 90px; right: 30px;
            background-color: var(--bg-dark-card); border: 1px solid var(--border-color-dark);
            border-radius: 8px; padding: 20px; width: 250px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000;
        }
        .settings-panel.show { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .settings-group { margin-bottom: 20px; }
        .settings-title { font-size: 0.9em; color: var(--text-dark-grey); text-transform: uppercase; font-weight: 700; margin-bottom: 10px; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 5px; }
        .settings-input {
            width: 100%; padding: 8px; background-color: var(--input-bg); border: 1px solid var(--border-color-dark);
            border-radius: 4px; color: var(--text-light-grey); margin-bottom: 8px; font-size: 0.9em; box-sizing: border-box;
        }
        .settings-input:focus { border-color: var(--text-blue); outline: none; }

        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .theme-btn { padding: 8px; border: 1px solid var(--border-color-dark); background: var(--input-bg); color: var(--text-light-grey); border-radius: 4px; cursor: pointer; font-size: 0.85em; text-align: center; transition: 0.2s; }
        .theme-btn:hover { background: var(--hover-bg); }
        .theme-btn.active { border-color: var(--text-blue); color: var(--text-blue); background: rgba(0, 170, 255, 0.1); }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-right: 10px; vertical-align: middle;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--input-bg); transition: .4s; border-radius: 34px; border: 1px solid var(--border-color-dark); }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 2px; background-color: var(--text-dark-grey); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--text-blue); }
        input:checked + .slider:before { transform: translateX(20px); background-color: white; }
        .switch-label { font-size: 0.9em; color: var(--text-light-grey); }

        .search-crimes-container { margin-bottom: 20px; position: relative; margin-right: 20px; max-width: 98%; }
        .search-crimes-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-dark-grey); }
        .search-crimes-input { width: 100%; padding: 15px 15px 15px 45px; background-color: var(--bg-dark-card); border: 1px solid var(--border-color-dark); border-radius: 8px; color: var(--text-light-grey); font-size: 1.1em; font-family: var(--main-font); outline: none; box-shadow: 0 4px 10px var(--shadow-light); transition: border-color 0.3s; box-sizing: border-box; }
        .search-crimes-input:focus { border-color: var(--text-blue); }

        #calculatorView { display: flex; gap: 30px; flex: 1; }
        .crime-columns { display: flex; flex: 1; gap: 20px; }
        .quadro.body-forms { flex: 1 1 30%; background-color: var(--bg-dark-card); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color-dark) !important; box-shadow: 0 4px 10px var(--shadow-light); min-height: 400px; }
        .quadro.body-forms hr { border-top: 1px solid var(--border-color-dark); margin: 15px 0; }
        .quadro.body-forms h3 { background-color: var(--crime-header-bg) !important; border-radius: 6px; padding: 12px 10px; margin-bottom: 20px; text-align: center; }
        .quadro.body-forms font { color: var(--crime-header-text) !important; font-size: 1em; font-weight: 600; }
        .checkbox-container { display: flex; align-items: flex-start; padding: 7px 0; font-size: 0.9em; color: var(--text-dark-grey); }
        .checkbox-container input[type="checkbox"] { margin-top: 3px; margin-right: 10px; accent-color: var(--text-blue); min-width: 18px; height: 18px; }
        .checkbox-container label { flex-grow: 1; line-height: 1.4; color: var(--text-dark-grey); cursor: pointer; }
        .checkbox-container input:checked + label { color: var(--text-light-grey); font-weight: 500; }

        /* Calculadora */
        .quadro.result-column { 
            flex: 0 0 300px; 
            background-color: var(--calc-result-bg) !important; 
            border-radius: 8px !important; padding: 25px; 
            box-shadow: 0 4px 15px var(--shadow-light); 
            color: var(--text-light-grey); 
            border: 1px solid var(--border-color-dark) !important; 
        }
        .quadro.result-column h3 { font-weight: 700; font-size: 1.2em; color: var(--text-light-grey); margin-top: 20px; }
        .quadro.result-column h4 { font-weight: 600; font-size: 1em; color: var(--text-blue); margin-top: 15px; }
        .quadro.result-column input[type="text"] { padding: 12px; background-color: var(--input-bg); border: 1px solid var(--text-blue); border-radius: 6px; color: var(--text-blue); font-size: 1.3em; font-weight: 700; text-align: right; box-shadow: 0 0 5px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; }
        .quadro.result-column button { width: 100%; padding: 12px; margin-top: 20px; font-size: 1.1em; font-weight: 700; border-radius: 6px; }
        .quadro.result-column textarea { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-light-grey); padding: 10px; font-size: 0.9em; border-radius: 6px; width: 100%; box-sizing: border-box; }
        .conversion-info { font-size: 0.9em; margin-top: 15px; padding: 8px; background-color: rgba(0,0,0,0.2); border: 1px solid var(--text-blue); border-radius: 6px; text-align: center; font-weight: 500; color: var(--text-light-grey); }
        .max-jail-info { font-size: 0.85em; color: var(--alert-red); font-weight: 600; margin-top: 5px; }
        .relatorio-container { width: 100%; margin-top: 20px; }
        .relatorio-container textarea { width: 100%; min-height: 100px; resize: vertical; }

        .footer { background-color: var(--bg-deep-dark); color: var(--text-dark-grey); text-align: center; padding: 15px; font-size: 0.85em; border-top: 1px solid var(--border-color-dark); flex-shrink: 0; font-family: var(--main-font); }
        .modal-overlay { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--bg-dark-card); margin: 5% auto; padding: 30px; border: 1px solid var(--text-blue); width: 80%; max-width: 1000px; max-height: 85vh; overflow-y: auto; border-radius: 12px; position: relative; color: var(--text-light-grey); }
        .close-modal { color: var(--text-dark-grey); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-modal:hover { color: var(--alert-red); }
        .penal-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .penal-table th, .penal-table td { border: 1px solid var(--border-color-dark); padding: 12px 15px; text-align: left; }
        .penal-table th { background-color: var(--crime-header-bg); color: var(--text-blue); font-weight: 700; position: sticky; top: 0; }
        .penal-table tr:hover { background-color: var(--hover-bg); }
        .penal-table td.cat-row { background-color: rgba(0,0,0,0.2); color: var(--text-light-grey); font-weight: bold; text-align: center; padding: 15px; }

        /* --- MODO MINIMALISTA --- */
        body.compact-mode .value-display-container, 
        body.compact-mode .social-buttons-container,
        body.compact-mode #btn-open-modal,
        body.compact-mode .conversion-info,
        body.compact-mode .max-jail-info {
            display: none !important;
        }

        body.compact-mode .inputs-container { display: flex !important; }
        body.compact-mode .corp-header { border-right: none; }
        body.compact-mode .value-display-container { border-right: none; }
        body.compact-mode .quadrotopo { padding: 10px 30px; margin-bottom: 15px; }

        /* --- RESPONSIVIDADE (MOBILE) --- */
        @media (max-width: 768px) {
            .content-area { padding: 15px; }
            .quadrotopo { flex-direction: column; align-items: center; gap: 15px; text-align: center; }
            .corp-header { border-right: none; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 10px; padding-right: 0; width: 100%; }
            .inputs-container { width: 100%; flex-direction: column; align-items: center; }
            .input-group-item { width: 100%; }
            .input-group-item input { width: 100%; box-sizing: border-box; }
            
            .right-controls-wrapper { margin-left: 0; justify-content: center; width: 100%; flex-wrap: wrap; }
            .value-display-container { border-right: none; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 10px; margin-bottom: 10px; width: 100%; text-align: center; }
            
            #calculatorView { flex-direction: column; }
            .crime-columns { flex-direction: column; }
            
            .quadro.result-column { flex: 1 1 auto; width: 100%; max-width: none; order: -1; }
            .search-crimes-container { max-width: 100%; margin-right: 0; }
        }
    </style>
</head>
<body>

<div id="welcomeOverlay" class="welcome-overlay">
    <div class="welcome-modal">
        <h2>Bem-vindo!</h2>
        <p>Fala, cidad√£o de ImersiON! Tudo certo?</p>
        <p>Antes de come√ßar seus trabalhos, seja na viatura ou no tribunal, clique na <strong>engrenagem</strong> <i class="fas fa-cog"></i> para configurar seu <strong>Nome</strong>, <strong>Profiss√£o</strong> e escolher o <strong>Tema</strong> visual que mais te agrada!</p>
        <button class="welcome-btn" onclick="dismissWelcome()">Entendi, vamos l√°!</button>
    </div>
</div>

<div class="main-wrapper">
    <div class="content-area" id="contentArea">
        
        <div class="quadrotopo">
            
            <div class="corp-header">
                <h2>C√≥digo Penal - ImersiON</h2>
                <div id="user-badge-container">
                    <span class="badge-name">Roleplay</span>
                </div>
            </div>

            <div class="inputs-container">
                <div class="input-group-item">
                    <h3>Nome do Preso</h3>
                    <input type="text" placeholder="Nome..." id="preso_nome" class="form-control">
                </div>
                <div class="input-group-item">
                    <h3>RG do Preso</h3>
                    <input type="number" placeholder="RG..." id="preso_rg" class="form-control">
                </div>
                <div class="input-group-item">
                    <h3>RG do Advogado</h3>
                    <input type="number" placeholder="RG..." id="adv_rg" class="form-control">
                </div>
            </div>

            <div class="right-controls-wrapper">
                
                <div class="value-display-container">
                    <div class="value-row">
                        <label>Advogado (60%):</label>
                        <span id="advogado_valor">R$ 0,00</span>
                    </div>
                    <div class="value-row">
                        <label>Policial (40%):</label>
                        <span id="policial_valor">R$ 0,00</span>
                    </div>
                </div>

                <button id="btn-open-modal" class="btn-penal">
                    <i class="fas fa-book"></i> C√ìDIGO PENAL
                </button>

                <div class="social-buttons-container">
                    <a href="https://www.instagram.com/imersionroleplay/" target="_blank" title="Instagram" class="icon-btn"><i class="fab fa-instagram"></i></a>
                    <a href="https://discord.gg/imersionrp" target="_blank" title="Discord" class="icon-btn"><i class="fab fa-discord"></i></a>
                </div>

                <button id="settingsBtn" class="icon-btn" title="Configura√ß√µes e Temas" style="border: 1px solid var(--text-blue); color: var(--text-blue);">
                    <i class="fas fa-cog"></i>
                </button>

                <div id="settingsPanel" class="settings-panel">
                    
                    <div class="settings-group">
                        <div class="settings-title">Identifica√ß√£o</div>
                        <input type="text" id="settingName" class="settings-input" placeholder="Seu Nome (Ex: Hondo)">
                        <input type="text" id="settingJob" class="settings-input" placeholder="Profiss√£o (Ex: Policial)">
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">Visualiza√ß√£o</div>
                        <label class="switch">
                            <input type="checkbox" id="compactModeToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">Modo Minimalista</span>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">Temas</div>
                        <div class="theme-grid">
                            <div class="theme-btn active" onclick="setTheme('default')">Padr√£o</div>
                            <div class="theme-btn" onclick="setTheme('light')">Light</div>
                            <div class="theme-btn" onclick="setTheme('police')">Pol√≠cia</div>
                            <div class="theme-btn" onclick="setTheme('gold')">Jur√≠dico</div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">Cor Personalizada</div>
                        <input type="color" id="customColorPicker" value="#00aaff" style="width: 100%; height: 30px; cursor: pointer;">
                    </div>
                </div>
            </div>
        </div>

        <div id="calculatorView">
            
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="search-crimes-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchCrimesInput" class="search-crimes-input" placeholder="Pesquisar crime (ex: Homic√≠dio, Roubo, Tr√°fico)...">
                </div>

                <div class="crime-columns">
                    <div id="col1" class="fc quadro form-control body-forms crime-list-container">
                        <h3 style="background-color: var(--crime-header-bg);"><font>1. CRIMES CONTRA A VIDA:</font></h3>
                        <div class="checkbox-container"><input id="1.1 - Homic√≠dio" type="checkbox" name="crime" value="60|12000|25000"><label for="1.1 - Homic√≠dio">1.1 - Homic√≠dio</label></div>
                        <div class="checkbox-container"><input id="1.2 - Tentativa de Homic√≠dio" type="checkbox" name="crime" value="45|8000|18000"><label for="1.2 - Tentativa de Homic√≠dio">1.2 - Tentativa de Homic√≠dio</label></div>
                        <div class="checkbox-container"><input id="1.3 - Chacina (2 V√≠timas)" type="checkbox" name="crime" value="60|20000|NA"><label for="1.3 - Chacina (2 V√≠timas)">1.3 - Chacina (2 V√≠timas)</label></div>
                        <div class="checkbox-container"><input id="1.4 - Chacina (3+ V√≠timas)" type="checkbox" name="crime" value="60|30000|NA"><label for="1.4 - Chacina (3+ V√≠timas)">1.4 - Chacina (3+ V√≠timas)</label></div>
                        <hr>
                        <h3 style="background-color: var(--crime-header-bg);"><font>2. DIREITOS FUNDAMENTAIS:</font></h3>
                        <div class="checkbox-container"><input id="2.1 - Les√£o corporal" type="checkbox" name="crime" value="12|3000|6000"><label for="2.1 - Les√£o corporal">2.1 - Les√£o corporal</label></div>
                        <div class="checkbox-container"><input id="2.2 - Sequestro" type="checkbox" name="crime" value="50|10000|20000"><label for="2.2 - Sequestro">2.2 - Sequestro</label></div>
                        <div class="checkbox-container"><input id="2.3 - C√°rcere privado" type="checkbox" name="crime" value="30|6000|12000"><label for="2.3 - C√°rcere privado">2.3 - C√°rcere privado</label></div>
                        <div class="checkbox-container"><input id="2.4 - Pris√£o ilegal" type="checkbox" name="crime" value="25|5000|10000"><label for="2.4 - Pris√£o ilegal">2.4 - Pris√£o ilegal</label></div>
                        <div class="checkbox-container"><input id="2.5 - Prevarica√ß√£o" type="checkbox" name="crime" value="35|9000|NA"><label for="2.5 - Prevarica√ß√£o">2.5 - Prevarica√ß√£o</label></div>
                        <div class="checkbox-container"><input id="2.6 - Obstru√ß√£o da justi√ßa" type="checkbox" name="crime" value="20|5000|10000"><label for="2.6 - Obstru√ß√£o da justi√ßa">2.6 - Obstru√ß√£o da justi√ßa</label></div>
                        <div class="checkbox-container"><input id="2.7 - Tentativa de suborno" type="checkbox" name="crime" value="30|8000|NA"><label for="2.7 - Tentativa de suborno">2.7 - Tentativa de suborno</label></div>
                        <hr>
                        <h3 style="background-color: var(--crime-header-bg);"><font>3. CRIMES CONTRA O PATRIM√îNIO:</font></h3>
                        <div class="checkbox-container"><input id="3.1 - Furto" type="checkbox" name="crime" value="12|3000|6000"><label for="3.1 - Furto">3.1 - Furto</label></div>
                        <div class="checkbox-container"><input id="3.2 - Tentativa de furto" type="checkbox" name="crime" value="8|1500|3000"><label for="3.2 - Tentativa de furto">3.2 - Tentativa de furto</label></div>
                        <div class="checkbox-container"><input id="3.3 - Recepta√ß√£o" type="checkbox" name="crime" value="18|3500|8000"><label for="3.3 - Recepta√ß√£o">3.3 - Recepta√ß√£o</label></div>
                        <div class="checkbox-container"><input id="3.4 - Furto de ve√≠culo" type="checkbox" name="crime" value="20|4000|9000"><label for="3.4 - Furto de ve√≠culo">3.4 - Furto de ve√≠culo</label></div>
                        <div class="checkbox-container"><input id="3.5 - Invas√£o de im√≥vel" type="checkbox" name="crime" value="22|6000|12000"><label for="3.5 - Invas√£o de im√≥vel">3.5 - Invas√£o de im√≥vel</label></div>
                        <div class="checkbox-container"><input id="3.6 - Roubo" type="checkbox" name="crime" value="30|7000|15000"><label for="3.6 - Roubo">3.6 - Roubo</label></div>
                        <div class="checkbox-container"><input id="3.7 - Roubo/Furto de viatura" type="checkbox" name="crime" value="30|10000|20000"><label for="3.7 - Roubo/Furto de viatura">3.7 - Roubo/Furto de viatura</label></div>
                        <div class="checkbox-container"><input id="3.8 - Estabelecimento irregular" type="checkbox" name="crime" value="6|2000|5000"><label for="3.8 - Estabelecimento irregular">3.8 - Estabelecimento irregular</label></div>
                        <div class="checkbox-container"><input id="3.9 - Falsifica√ß√£o de alvar√°" type="checkbox" name="crime" value="24|6000|12000"><label for="3.9 - Falsifica√ß√£o de alvar√°">3.9 - Falsifica√ß√£o de alvar√°</label></div>
                        <hr>
                    </div>

                    <div id="col2" class="fc quadro form-control body-forms crime-list-container">
                        <h3 style="background-color: var(--crime-header-bg);"><font>4. ROUBO, EXTORS√ÉO E ESTELIONATO:</font></h3>
                        <div class="checkbox-container"><input id="4.1 - Assalto" type="checkbox" name="crime" value="24|6000|12000"><label for="4.1 - Assalto">4.1 - Assalto</label></div>
                        <div class="checkbox-container"><input id="4.2 - Extors√£o" type="checkbox" name="crime" value="30|7000|15000"><label for="4.2 - Extors√£o">4.2 - Extors√£o</label></div>
                        <div class="checkbox-container"><input id="4.3 - Furto a caixa eletr√¥nico" type="checkbox" name="crime" value="35|8000|18000"><label for="4.3 - Furto a caixa eletr√¥nico">4.3 - Furto a caixa eletr√¥nico</label></div>
                        <div class="checkbox-container"><input id="4.4 - Estelionato simples" type="checkbox" name="crime" value="18|4000|8000"><label for="4.4 - Estelionato simples">4.4 - Estelionato simples</label></div>
                        <div class="checkbox-container"><input id="4.5 - Golpe financeiro" type="checkbox" name="crime" value="24|6000|12000"><label for="4.5 - Golpe financeiro">4.5 - Golpe financeiro</label></div>
                        <div class="checkbox-container"><input id="4.6 - Golpe banc√°rio" type="checkbox" name="crime" value="30|8000|18000"><label for="4.6 - Golpe banc√°rio">4.6 - Golpe banc√°rio</label></div>
                        <div class="checkbox-container"><input id="4.7 - Estelionato em massa" type="checkbox" name="crime" value="40|12000|25000"><label for="4.7 - Estelionato em massa">4.7 - Estelionato em massa</label></div>
                        <hr>
                        <h3 style="background-color: var(--crime-header-bg);"><font>5. ARMAS E MUNI√á√ïES:</font></h3>
                        <div class="checkbox-container"><input id="5.1 - Porte de arma leve" type="checkbox" name="crime" value="20|5000|12000"><label for="5.1 - Porte de arma leve">5.1 - Porte de arma leve</label></div>
                        <div class="checkbox-container"><input id="5.2 - Porte de arma pesada" type="checkbox" name="crime" value="35|10000|20000"><label for="5.2 - Porte de arma pesada">5.2 - Porte de arma pesada</label></div>
                        <div class="checkbox-container"><input id="5.3 - Tr√°fico de armas" type="checkbox" name="crime" value="50|15000|30000"><label for="5.3 - Tr√°fico de armas">5.3 - Tr√°fico de armas</label></div>
                        <div class="checkbox-container"><input id="5.4 - Posse de muni√ß√£o (-250)" type="checkbox" name="crime" value="10|2000|5000"><label for="5.4 - Posse de muni√ß√£o (-250)">5.4 - Posse de muni√ß√£o (-250)</label></div>
                        <div class="checkbox-container"><input id="5.5 - Tr√°fico de muni√ß√£o (+250)" type="checkbox" name="crime" value="24|7000|15000"><label for="5.5 - Tr√°fico de muni√ß√£o (+250)">5.5 - Tr√°fico de muni√ß√£o (+250)</label></div>
                        <div class="checkbox-container"><input id="5.6 - Posse de arma branca" type="checkbox" name="crime" value="6|1000|3000"><label for="5.6 - Posse de arma branca">5.6 - Posse de arma branca</label></div>
                        <div class="checkbox-container"><input id="5.7 - Posse de material ilegal" type="checkbox" name="crime" value="16|4000|8000"><label for="5.7 - Posse de material ilegal">5.7 - Posse de material ilegal</label></div>
                        <hr>
                        <h3 style="background-color: var(--crime-header-bg);"><font>6. NARCOTR√ÅFICO:</font></h3>
                        <div class="checkbox-container"><input id="6.1 - Posse de drogas (1-6)" type="checkbox" name="crime" value="0|0|0"><label for="6.1 - Posse de drogas (1-6)">6.1 - Posse de drogas (1-6)</label></div>
                        <div class="checkbox-container"><input id="6.2 - Tr√°fico de drogas" type="checkbox" name="crime" value="45|12000|25000"><label for="6.2 - Tr√°fico de drogas">6.2 - Tr√°fico de drogas</label></div>
                        <hr>
                        <h3 style="background-color: var(--crime-header-bg);"><font>7. CRIMES CIBERN√âTICOS:</font></h3>
                        <div class="checkbox-container"><input id="7.1 - Invas√£o de sistema" type="checkbox" name="crime" value="20|5000|10000"><label for="7.1 - Invas√£o de sistema">7.1 - Invas√£o de sistema</label></div>
                        <div class="checkbox-container"><input id="7.2 - Clonagem de celular" type="checkbox" name="crime" value="18|4000|8000"><label for="7.2 - Clonagem de celular">7.2 - Clonagem de celular</label></div>
                        <div class="checkbox-container"><input id="7.3 - Fraude digital" type="checkbox" name="crime" value="24|6000|12000"><label for="7.3 - Fraude digital">7.3 - Fraude digital</label></div>
                        <div class="checkbox-container"><input id="7.4 - Uso de software ilegal" type="checkbox" name="crime" value="14|3000|6000"><label for="7.4 - Uso de software ilegal">7.4 - Uso de software ilegal</label></div>
                        <div class="checkbox-container"><input id="7.5 - Vazamento de dados" type="checkbox" name="crime" value="30|8000|18000"><label for="7.5 - Vazamento de dados">7.5 - Vazamento de dados</label></div>
                        <hr>
                    </div>

                    <div id="col3" class="fc quadro form-control body-forms crime-list-container">
                        <h3 style="background-color: var(--crime-header-bg);"><font>8. RELA√á√ïES CONJUGAIS:</font></h3>
                        <div class="checkbox-container"><input id="8.1 - Agress√£o conjugal" type="checkbox" name="crime" value="20|4000|8000"><label for="8.1 - Agress√£o conjugal">8.1 - Agress√£o conjugal</label></div>
                        <div class="checkbox-container"><input id="8.2 - Les√£o conjugal" type="checkbox" name="crime" value="30|6000|12000"><label for="8.2 - Les√£o conjugal">8.2 - Les√£o conjugal</label></div>
                        <div class="checkbox-container"><input id="8.3 - Amea√ßa conjugal" type="checkbox" name="crime" value="14|3000|6000"><label for="8.3 - Amea√ßa conjugal">8.3 - Amea√ßa conjugal</label></div>
                        <div class="checkbox-container"><input id="8.4 - Persegui√ß√£o (stalking)" type="checkbox" name="crime" value="22|5000|10000"><label for="8.4 - Persegui√ß√£o (stalking)">8.4 - Persegui√ß√£o (stalking)</label></div>
                        <div class="checkbox-container"><input id="8.5 - C√°rcere privado conjugal" type="checkbox" name="crime" value="40|8000|18000"><label for="8.5 - C√°rcere privado conjugal">8.5 - C√°rcere privado conjugal</label></div>
                        <div class="checkbox-container"><input id="8.6 - Estelionato conjugal" type="checkbox" name="crime" value="28|7000|15000"><label for="8.6 - Estelionato conjugal">8.6 - Estelionato conjugal</label></div>
                        <div class="checkbox-container"><input id="8.7 - Tentativa de homic√≠dio conjugal" type="checkbox" name="crime" value="45|10000|20000"><label for="8.7 - Tentativa de homic√≠dio conjugal">8.7 - Tent. Homic√≠dio conjugal</label></div>
                        <div class="checkbox-container"><input id="8.8 - Homicidio conjugal" type="checkbox" name="crime" value="60|15000|NA"><label for="8.8 - Homicidio conjugal">8.8 - Homicidio conjugal</label></div>
                        <hr>
                        <h3 style="background-color: var(--crime-header-bg);"><font>9. ORDEM P√öBLICA:</font></h3>
                        <div class="checkbox-container"><input id="9.1 - Amea√ßa" type="checkbox" name="crime" value="10|2000|5000"><label for="9.1 - Amea√ßa">9.1 - Amea√ßa</label></div>
                        <div class="checkbox-container"><input id="9.2 - Desobedi√™ncia" type="checkbox" name="crime" value="8|1500|3000"><label for="9.2 - Desobedi√™ncia">9.2 - Desobedi√™ncia</label></div>
                        <div class="checkbox-container"><input id="9.3 - Vandalismo" type="checkbox" name="crime" value="12|3500|3500"><label for="9.3 - Vandalismo">9.3 - Vandalismo</label></div>
                        <div class="checkbox-container"><input id="9.4 - Dano ao patrim√¥nio p√∫blico" type="checkbox" name="crime" value="18|4000|8000"><label for="9.4 - Dano ao patrim√¥nio p√∫blico">9.4 - Dano ao patrim√¥nio p√∫blico</label></div>
                        <div class="checkbox-container"><input id="9.5 - Abuso de autoridade" type="checkbox" name="crime" value="30|6000|12000"><label for="9.5 - Abuso de autoridade">9.5 - Abuso de autoridade</label></div>
                        <div class="checkbox-container"><input id="9.6 - Uso de m√°scara" type="checkbox" name="crime" value="10|3000|6000"><label for="9.6 - Uso de m√°scara">9.6 - Uso de m√°scara</label></div>
                        <div class="checkbox-container"><input id="9.7 - Uso de equipamento restrito" type="checkbox" name="crime" value="20|5000|10000"><label for="9.7 - Uso de equipamento restrito">9.7 - Uso de equipamento restrito</label></div>
                        <hr>
                        <h3 style="background-color: var(--crime-header-bg);"><font>10. TR√ÇNSITO (CTB):</font></h3>
                        <div class="checkbox-container"><input id="10.1 - Tentativa de fuga" type="checkbox" name="crime" value="14|3000|8000"><label for="10.1 - Tentativa de fuga">10.1 - Tentativa de fuga</label></div>
                        <div class="checkbox-container"><input id="10.2 - Corridas ilegais" type="checkbox" name="crime" value="20|6000|NA"><label for="10.2 - Corridas ilegais">10.2 - Corridas ilegais</label></div>
                        <div class="checkbox-container"><input id="10.3 - Homic√≠dio culposo no tr√¢nsito" type="checkbox" name="crime" value="25|6000|15000"><label for="10.3 - Homic√≠dio culposo no tr√¢nsito">10.3 - Homic. culposo no tr√¢nsito</label></div>
                        <div class="checkbox-container"><input id="10.4 - Tentativa de homic√≠dio no tr√¢nsito" type="checkbox" name="crime" value="30|7000|18000"><label for="10.4 - Tent. homic√≠dio no tr√¢nsito">10.4 - Tent. homic√≠dio no tr√¢nsito</label></div>
                        <hr>
                        <h3 style="background-color: var(--crime-header-bg);"><font>AGRAVANTES:</font></h3>
                        <div class="checkbox-container"><input id="14.1 - Desacato a autoridade" type="checkbox" name="crime" value="5|1400|4000"><label for="14.1 - Desacato a autoridade">14.1 - Desacato a autoridade</label></div>
                        <div class="checkbox-container"><input id="14.2 - Resist√™ncia a Pris√£o" type="checkbox" name="crime" value="5|3000|8000"><label for="14.2 - Resist√™ncia a Pris√£o">14.2 - Resist√™ncia a Pris√£o</label></div>
                        <hr>
                    </div>
                </div>
            </div>

            <div class="quadro result-column">
                <h3 style="font-size: 30px; font-weight: 400; font-style: oblique; color: var(--text-blue);">CALCULADORA</h3>
                
                <div class="conversion-info">
                    <strong>10 Meses (no jogo) = 60 Minutos (vida real)</strong>
                    <p class="max-jail-info" style="color: var(--text-dark-grey); margin-top: 5px;">
                        (Pena m√°xima de 60 meses aplicada)
                    </p>
                    <p class="max-jail-info" style="color: var(--alert-red); margin-top: 5px;">
                        Se a Lei de Miranda n√£o for lida, anula toda opera√ß√£o
                    </p>
                </div>
                
                <h4>‚öñÔ∏è PENA:</h4>
                <input type="text" id="pena" name="pena" class="form-control" readonly="true">
                <div class="max-jail-info" id="max-jail-info" style="display: none">
                    * PENA M√ÅXIMA (60 MESES) EXCEDIDA
                </div>
                
                <h4>üí∏ MULTA:</h4>
                <input type="text" id="multa" name="multa" class="form-control" readonly="true">
                
                <h4>üí∞ FIAN√áA:</h4>
                <input type="text" id="fianca" name="fianca" class="form-control" readonly="true">
                <input hidden="" id="fianca-hidden">
                <br>

                <button class="btn btn-danger" style="background-color: var(--original-red); color: white; border: none;" id="limpar-calc">
                    <i class="fas fa-trash" style="color: #fff; font-size: 20px;"></i> <span>LIMPAR</span>
                </button>
                <hr>
                
                <h3 style="font-size: 18px;">FICHA CRIMINAL:</h3>
                <textarea rows="10" cols="50" style="resize: none" readonly="true" maxlength="500" id="copy-text" class="TextoArtigos form-control"></textarea>

                <br>
                <button class="btn btn-success" style="background-color: #00c003; color: white; border: none;" id="copy-btn">
                    <i class="fas fa-clipboard" style="color: #fff; font-size: 20px;"></i> <span>COPIAR PARA DISCORD</span>
                </button>
                
                <hr>

                <h3>ATENUANTES:</h3>
                <div style="font-size: 15px;">
                    <input type="checkbox" class="form-check-input side-checkboxes" id="advogado-30" name="advogado-30" value="30"> Advogado constitu√≠do: <span style="color:#888">Redu√ß√£o de 30%</span>
                    
                    <div class="col col-md-12 advogado-1" style="display: none; margin-top: 10px;">
                        <h4 style="font-size: 15px; color: var(--original-red);">
                            <input id="reu-primario" type="checkbox" class="form-check-input side-checkboxes" value="50" name="reu-primario"> R√©u prim√°rio: <span style="color:#888">Redu√ß√£o de 50%</span>
                        </h4>
                    </div>

                    <div class="col col-md-12 advogado-2" style="display: none; margin-top: 10px;">
                        <h4 style="font-size: 15px; color: var(--original-red);">
                            <input id="reu-confesso" type="checkbox" class="form-check-input side-checkboxes" value="15" name="reu-confesso"> R√©u confesso: <span style="color:#888">Redu√ß√£o de 15%</span>
                        </h4>
                    </div>
                </div>
                <hr style="margin-bottom: 10px;">
                
                <div style="font-size: 15px; margin-top: 5px;">
                    <input type="checkbox" class="form-check-input side-checkboxes" id="oac-checkbox" name="oac-checkbox" value="100"> POSSUI OAC: <span style="color:#888">Aumento de 100%</span>
                </div>
                <hr style="margin-top: 20px;">
                
                <h3 style="font-size: 18px;">RELAT√ìRIO:</h3>
                <div class="relatorio-container">
                    <textarea rows="5" id="relatorio_content" class="form-control" placeholder="Detalhes do RP, atenuantes do advogado, nome do policial respons√°vel, etc..."></textarea>
                </div>
            </div>
            
        </div>
        
    </div>
    
</div>

<div id="modalPenalCode" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="modal-header">
            <h2>Tabela Completa - C√≥digo Penal</h2>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<footer class="footer">
    Autor <strong>Nox</strong>, todos direitos reservados - 2025.
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const crimeCheckboxes = document.querySelectorAll('.crime-columns input[type="checkbox"]');
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        const limparCalcBtn = document.getElementById('limpar-calc');
        const copyBtn = document.getElementById('copy-btn');
        const penaInput = document.getElementById('pena');
        const multaInput = document.getElementById('multa');
        const fiancaInput = document.getElementById('fianca');
        const copyTextarea = document.getElementById('copy-text');
        const maxJailInfo = document.getElementById('max-jail-info');
        
        const nomePresoInput = document.getElementById('preso_nome');
        const rgPresoInput = document.getElementById('preso_rg');
        const rgAdvogadoInput = document.getElementById('adv_rg');
        const relatorioInput = document.getElementById('relatorio_content');
        const oacCheckbox = document.getElementById('oac-checkbox');

        const advogadoValorSpan = document.getElementById('advogado_valor');
        const policialValorSpan = document.getElementById('policial_valor');
        
        const searchInput = document.getElementById('searchCrimesInput');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const compactModeToggle = document.getElementById('compactModeToggle');
        const customColorPicker = document.getElementById('customColorPicker');
        
        // Welcome Modal
        const welcomeOverlay = document.getElementById('welcomeOverlay');

        // Identifica√ß√£o
        const settingName = document.getElementById('settingName');
        const settingJob = document.getElementById('settingJob');
        const userBadgeContainer = document.getElementById('user-badge-container');

        const MINUTES_PER_MONTH_SCALE = 6; 
        const MAX_PENALTY_MONTHS = 60; 
        const INAFIANCAVEL_TEXT = "INAFIAN√á√ÅVEL";
        const ADVOGADO_PERCENTAGE = 0.60; 
        const POLICIAL_PERCENTAGE = 0.40; 

        // --- L√ìGICA DO TUTORIAL (MODAL) ---
        window.dismissWelcome = () => {
            welcomeOverlay.style.display = 'none';
            localStorage.setItem('tutorialDismissed', 'true');
        };

        function checkTutorial() {
            // Se N√ÉO tiver a chave no storage, mostra o modal
            if(!localStorage.getItem('tutorialDismissed')) {
                welcomeOverlay.style.display = 'flex'; // Flex para centralizar
            }
        }

        // --- SISTEMA DE SALVAMENTO (LOCALSTORAGE) ---
        function saveState() {
            // Salvar Inputs de Texto
            localStorage.setItem('preso_nome', nomePresoInput.value);
            localStorage.setItem('preso_rg', rgPresoInput.value);
            localStorage.setItem('adv_rg', rgAdvogadoInput.value);
            localStorage.setItem('relatorio', relatorioInput.value);

            // Salvar Checkboxes Marcados
            const checkedIds = [];
            allCheckboxes.forEach(cb => {
                if(cb.checked) checkedIds.push(cb.id);
            });
            localStorage.setItem('checkedItems', JSON.stringify(checkedIds));
        }

        function loadState() {
            // Carregar Inputs
            if(localStorage.getItem('preso_nome')) nomePresoInput.value = localStorage.getItem('preso_nome');
            if(localStorage.getItem('preso_rg')) rgPresoInput.value = localStorage.getItem('preso_rg');
            if(localStorage.getItem('adv_rg')) rgAdvogadoInput.value = localStorage.getItem('adv_rg');
            if(localStorage.getItem('relatorio')) relatorioInput.value = localStorage.getItem('relatorio');

            // Carregar Checkboxes
            const checkedItems = JSON.parse(localStorage.getItem('checkedItems')) || [];
            checkedItems.forEach(id => {
                const cb = document.getElementById(id);
                if(cb) cb.checked = true;
            });

            // CORRIGIDO: Carregar Configura√ß√µes com Cor Personalizada Preservada
            if(localStorage.getItem('rpName')) settingName.value = localStorage.getItem('rpName');
            if(localStorage.getItem('rpJob')) settingJob.value = localStorage.getItem('rpJob');
            
            // 1. Pega a cor salva, se houver
            const savedColor = localStorage.getItem('customColor');
            
            // 2. Aplica o tema (isso pode resetar a cor se for default, mas vamos corrigir abaixo)
            if(localStorage.getItem('selectedTheme')) {
                setTheme(localStorage.getItem('selectedTheme'), false); // false = n√£o √© um reset pelo bot√£o
            }
            
            // 3. Se tinha uma cor salva, aplica ela por cima de tudo
            if(savedColor) {
                customColorPicker.value = savedColor;
                document.documentElement.style.setProperty('--text-blue', savedColor);
                // Garante que o storage mantenha a cor
                localStorage.setItem('customColor', savedColor);
            }

            if(localStorage.getItem('isCompact') === 'true') {
                compactModeToggle.checked = true;
                document.body.classList.add('compact-mode');
            }

            updateUserBadge();
            updateCalculation();
            checkTutorial(); // Verifica se precisa mostrar o modal
        }

        function updateUserBadge() {
            const name = settingName.value.trim();
            const job = settingJob.value.trim();
            
            // Limpa o container
            userBadgeContainer.innerHTML = '';

            if(!name && !job) {
                userBadgeContainer.innerHTML = `<span class="badge-name">Roleplay</span>`;
            } else {
                if(name) {
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'badge-name';
                    nameSpan.textContent = name;
                    userBadgeContainer.appendChild(nameSpan);
                }
                if(job) {
                    const jobSpan = document.createElement('span');
                    jobSpan.className = 'badge-job';
                    // Se houver nome, adiciona v√≠rgula antes
                    jobSpan.textContent = name ? `, ${job}` : job;
                    userBadgeContainer.appendChild(jobSpan);
                }
            }
            localStorage.setItem('rpName', name);
            localStorage.setItem('rpJob', job);
        }

        settingName.addEventListener('input', updateUserBadge);
        settingJob.addEventListener('input', updateUserBadge);

        // --- L√ìGICA DA CALCULADORA ---

        const formatCurrency = (value) => {
            return `R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        };

        const copyToClipboard = async (text) => {
            try {
                await navigator.clipboard.writeText(text);
                alert('Copiado com sucesso!');
            } catch (err) {
                copyTextarea.select();
                document.execCommand("copy");
                alert('Texto selecionado para c√≥pia.');
            }
        };

        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const columns = document.querySelectorAll('.crime-list-container');
            columns.forEach(column => {
                let currentHeader = null;
                let currentHr = null;
                let itemsInGroup = [];
                const processGroup = () => {
                    if (!currentHeader) return;
                    let hasMatch = false;
                    itemsInGroup.forEach(item => {
                        const label = item.querySelector('label').textContent.toLowerCase();
                        if (label.includes(searchTerm)) { item.style.display = 'flex'; hasMatch = true; } 
                        else { item.style.display = 'none'; }
                    });
                    if (hasMatch) {
                        currentHeader.style.display = 'block';
                        if (currentHr) currentHr.style.display = 'block';
                    } else {
                        currentHeader.style.display = 'none';
                        if (currentHr) currentHr.style.display = 'none';
                    }
                };
                Array.from(column.children).forEach(child => {
                    if (child.tagName === 'H3') {
                        processGroup();
                        currentHeader = child;
                        itemsInGroup = [];
                        currentHr = null;
                    } else if (child.tagName === 'HR') {
                        currentHr = child;
                    } else if (child.classList.contains('checkbox-container')) {
                        itemsInGroup.push(child);
                    }
                });
                processGroup();
            });
        });

        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsPanel.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
                settingsPanel.classList.remove('show');
            }
        });

        compactModeToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }
            localStorage.setItem('isCompact', e.target.checked);
        });

        window.setTheme = (themeName, isReset = true) => {
            document.body.removeAttribute('data-theme');
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            
            if (themeName === 'default') {
                // S√ì reseta a cor se for um clique do usu√°rio (isReset = true)
                // Se for carregamento de p√°gina, n√£o reseta.
                if (isReset) {
                    const defaultColor = '#00aaff';
                    document.documentElement.style.setProperty('--text-blue', defaultColor);
                    customColorPicker.value = defaultColor;
                    localStorage.removeItem('customColor'); 
                }
            } else {
                document.body.setAttribute('data-theme', themeName);
                document.documentElement.style.removeProperty('--text-blue');
            }

            localStorage.setItem('selectedTheme', themeName);
        };

        customColorPicker.addEventListener('input', (e) => {
            document.documentElement.style.setProperty('--text-blue', e.target.value);
            localStorage.setItem('customColor', e.target.value);
        });

        const updateCalculation = () => {
            let totalPenaMonths = 0;
            let totalMulta = 0;
            let totalFianca = 0;
            let hasInafiancavel = false;
            let crimesSelecionados = [];
            let atenuantesList = [];

            crimeCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const [penaStr, multaStr, fiancaStr] = checkbox.value.split('|');
                    const pena = parseInt(penaStr) || 0; 
                    const multa = parseInt(multaStr) || 0;
                    totalPenaMonths += pena;
                    totalMulta += multa;
                    if (fiancaStr.toUpperCase() === 'NA') { hasInafiancavel = true; } 
                    else { totalFianca += parseInt(fiancaStr) || 0; }
                    crimesSelecionados.push(checkbox.id);
                }
            });
            
            let penaFinalMonths = totalPenaMonths;
            let multaFinal = totalMulta;
            
            const advConst = document.getElementById('advogado-30').checked;
            const reuPrimarioEl = document.getElementById('reu-primario');
            const reuConfessoEl = document.getElementById('reu-confesso');

            document.querySelectorAll('.advogado-1, .advogado-2').forEach(el => {
                el.style.display = advConst ? 'block' : 'none';
            });
            
            if (advConst) {
                penaFinalMonths = Math.ceil(penaFinalMonths * 0.70); 
                atenuantesList.push("Advogado Constitu√≠do (Redu√ß√£o de 30%)");
                if (reuPrimarioEl.checked) {
                    penaFinalMonths = Math.ceil(penaFinalMonths * 0.50); 
                    atenuantesList.push("R√©u Prim√°rio (Redu√ß√£o de 50%)");
                }
                if (reuConfessoEl.checked) {
                    penaFinalMonths = Math.ceil(penaFinalMonths * 0.85); 
                    atenuantesList.push("R√©u Confesso (Redu√ß√£o de 15%)");
                }
            }

            if (oacCheckbox && oacCheckbox.checked) {
                 penaFinalMonths = Math.ceil(penaFinalMonths * 2.0); 
                 atenuantesList.push("POSSUI OAC (Aumento de 100%)");
            }
            
            const penaExceeded = penaFinalMonths > MAX_PENALTY_MONTHS;
            if (penaExceeded) { penaFinalMonths = MAX_PENALTY_MONTHS; }
            maxJailInfo.style.display = penaExceeded ? 'block' : 'none';
            
            let fiancaDisplay;
            let fiancaValue = totalFianca;

            if (hasInafiancavel) {
                fiancaDisplay = INAFIANCAVEL_TEXT;
                fiancaValue = 0; 
            } else if (totalFianca > 0) {
                fiancaDisplay = formatCurrency(totalFianca);
            } else if (multaFinal > 0) {
                fiancaValue = multaFinal;
                fiancaDisplay = formatCurrency(multaFinal);
            } else {
                fiancaDisplay = formatCurrency(0);
            }
            
            if (crimesSelecionados.length === 0) {
                fiancaDisplay = formatCurrency(0);
                fiancaValue = 0;
            }

            const valorAdvogado = fiancaValue * ADVOGADO_PERCENTAGE;
            const valorPolicial = fiancaValue * POLICIAL_PERCENTAGE;
            
            const penaFinalRealMinutes = penaFinalMonths * MINUTES_PER_MONTH_SCALE; 
            penaInput.value = penaFinalMonths > 0 ? `${penaFinalMonths} Meses (${penaFinalRealMinutes} Min)` : '0 Meses';
            multaInput.value = formatCurrency(multaFinal);
            fiancaInput.value = fiancaDisplay;
            
            advogadoValorSpan.textContent = formatCurrency(valorAdvogado);
            policialValorSpan.textContent = formatCurrency(valorPolicial);

            const atenuantesText = atenuantesList.length > 0 ? atenuantesList.join(', ') : 'Nenhum';
            const crimesSequencia = crimesSelecionados.map(crime => `- ${crime}`).join('\n');
            const nomePreso = nomePresoInput.value.trim() || 'N/A';
            const rgPreso = rgPresoInput.value.trim() || 'N/A';
            const rgAdvogado = rgAdvogadoInput.value.trim() || 'N/A';
            const relatorio = relatorioInput.value.trim() || 'N/A';
            
            const discordTemplate = `# Ficha Criminal \n\n**Nome:** ${nomePreso}\n**RG do Preso:** ${rgPreso}\n**Observa√ß√£o:**\n**Crimes:**\n${crimesSequencia}\n\n**Pena Total:** ${penaInput.value}\n**Multa:** ${multaInput.value}\n**Fian√ßa:** ${fiancaInput.value}\n\n**Atenuantes:** ${atenuantesText}\n\n**RG do Advogado:** ${rgAdvogado}\n**Fian√ßa paga?:** (PREENCHER)\n\n**Policial Respons√°vel:** (PREENCHER)\n**Policiais Envolvidos:** (PREENCHER)\n\n**Relat√≥rio:** ${relatorio}\n`;

            copyTextarea.value = discordTemplate;
            
            // Salvar estado atual ap√≥s c√°lculo
            saveState();
        };

        limparCalcBtn.addEventListener('click', () => {
            // Limpa visualmente
            allCheckboxes.forEach(cb => cb.checked = false);
            nomePresoInput.value = '';
            rgPresoInput.value = '';
            rgAdvogadoInput.value = '';
            relatorioInput.value = '';
            searchInput.value = ''; 
            searchInput.dispatchEvent(new Event('input'));
            
            // Limpa dados de c√°lculo do Storage
            // NOTA: N√ÉO removo mais o tutorialDismissed aqui.
            localStorage.removeItem('preso_nome');
            localStorage.removeItem('preso_rg');
            localStorage.removeItem('adv_rg');
            localStorage.removeItem('relatorio');
            localStorage.removeItem('checkedItems');

            updateCalculation();
        });

        allCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', updateCalculation); });
        nomePresoInput.addEventListener('input', updateCalculation);
        rgPresoInput.addEventListener('input', updateCalculation);
        rgAdvogadoInput.addEventListener('input', updateCalculation);
        relatorioInput.addEventListener('input', updateCalculation);
        copyBtn.addEventListener('click', () => { copyToClipboard(copyTextarea.value); });

        const modal = document.getElementById("modalPenalCode");
        const btnModal = document.getElementById("btn-open-modal");
        const spanClose = document.querySelector(".close-modal");
        const modalBody = document.getElementById("modalBody");

        function generatePenalTable() {
            let tableHTML = `<table class="penal-table"><thead><tr><th>Artigo / Crime</th><th>Pena (Meses)</th><th>Multa</th><th>Fian√ßa</th></tr></thead><tbody>`;
            const colunas = document.querySelectorAll('.crime-columns .body-forms');
            colunas.forEach(coluna => {
                const elementos = coluna.children;
                for (let el of elementos) {
                    if (el.tagName === 'H3') {
                        const categoriaTitulo = el.textContent.replace(':', '');
                        tableHTML += `<tr><td colspan="4" class="cat-row">${categoriaTitulo}</td></tr>`;
                    } else if (el.classList.contains('checkbox-container')) {
                        const input = el.querySelector('input');
                        const label = el.querySelector('label').textContent;
                        const values = input.value.split('|');
                        const pena = values[0] + " Meses";
                        const multa = parseInt(values[1]).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                        let fianca = "R$ 0,00";
                        if(values[2] === "NA") { fianca = "<span style='color:var(--alert-red); font-weight:bold;'>INAFIAN√á√ÅVEL</span>"; } 
                        else if(parseInt(values[2]) > 0) { fianca = parseInt(values[2]).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); } 
                        else if (parseInt(values[1]) > 0) { fianca = parseInt(values[1]).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
                        tableHTML += `<tr><td><strong>${label}</strong></td><td>${pena}</td><td>${multa}</td><td>${fianca}</td></tr>`;
                    }
                }
            });
            tableHTML += `</tbody></table>`;
            modalBody.innerHTML = tableHTML;
        }

        btnModal.onclick = function() { generatePenalTable(); modal.style.display = "block"; }
        spanClose.onclick = function() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) { modal.style.display = "none"; } }

        // Carregar estado ao iniciar
        loadState();
    });
</script>

</body>
</html>
